/**
 * CUSTOMERS.GS - 17 SÜTUN TAM UYUMLU SÜRÜM
 * Sütun Yapısı: A:ID, B:Ad, C:Tip, D:Ülke, E:Şehir, F:Tel, G:Eposta, H:Web, 
 * I:Adres, J:Ödeme, K:Nakliye, L:Durum, M:Notlar, N:Ol.Tar, O:Olusturan, P:Gun.Tar, Q:Guncelleyen
 */

// 1. Müşteri Listesi (Dashboard Tablosu İçin)
function getCustomerList() {
  try {
    const ss = SpreadsheetApp.openById(DB_ID);
    const sheet = ss.getSheetByName("Musteriler");
    if (!sheet) return { status: "error", message: "Musteriler tablosu bulunamadı!" };

    const data = sheet.getDataRange().getValues();
    const customers = [];

    // Başlık hariç (1. satırdan başla)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if(!row[0] || row[0] === "") continue; 

      customers.push({
        id: row[0],         // A: Musteri_ID
        name: row[1],       // B: Firma_Adi
        type: row[2],       // C: Tip
        country: row[3],    // D: Ulke
        city: row[4],       // E: Sehir
        phone: row[5],      // F: Telefon
        email: row[6],      // G: E_Posta
        status: row[11],    // L: Durum
        creator: row[14]    // O: Olusturan_Kullanici_ID
      });
    }
    
    // Yeni eklenenlerin en üstte görünmesi için listeyi ters çeviriyoruz
    return { status: "success", data: customers.reverse() };
  } catch (err) {
    return { status: "error", message: "Liste çekme hatası: " + err.toString() };
  }
}

// 2. Müşteri Detayı (Düzenleme ve Görüntüleme Ekranları İçin)
function getCustomerDetail(id) {
  try {
    const ss = SpreadsheetApp.openById(DB_ID);
    const sheet = ss.getSheetByName("Musteriler");
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0] == id) {
        return {
          status: "success",
          data: {
            id: row[0],         // A: Musteri_ID
            name: row[1],       // B: Firma_Adi
            type: row[2],       // C: Tip
            country: row[3],    // D: Ulke
            city: row[4],       // E: Sehir
            phone: row[5],      // F: Telefon
            email: row[6],      // G: E_Posta
            website: row[7],    // H: Web_Sitesi
            address: row[8],    // I: Adres
            payment: row[9],    // J: Odeme_Sekli
            shipping: row[10],  // K: Nakliye_Tipi
            status: row[11],    // L: Durum
            notes: row[12]      // M: Not_Ozet
          }
        };
      }
    }
    return { status: "error", message: "Müşteri bulunamadı." };
  } catch (err) {
    return { status: "error", message: "Detay hatası: " + err.toString() };
  }
}

// 3. Müşteri Kaydet (EKLEME ve GÜNCELLEME)
function saveCustomer(data) {
  try {
    const ss = SpreadsheetApp.openById(DB_ID);
    const sheet = ss.getSheetByName("Musteriler");
    const rows = sheet.getDataRange().getValues();
    const now = new Date();
    const currentUser = data.user || "Admin"; 
    
    // A. GÜNCELLEME (ID varsa)
    if (data.id && data.id !== "" && data.id !== "new") {
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0] == data.id) {
          // B (2) sütunundan M (13) sütununa kadar (Toplam 12 sütunluk veri seti)
          sheet.getRange(i + 1, 2, 1, 12).setValues([[
            data.name,      // B: Firma_Adi
            data.type,      // C: Tip
            data.country,   // D: Ulke
            data.city,      // E: Sehir
            data.phone,     // F: Telefon
            data.email,     // G: E_Posta
            data.website,   // H: Web_Sitesi
            data.address,   // I: Adres
            data.payment,   // J: Odeme_Sekli
            data.shipping,  // K: Nakliye_Tipi
            data.status,    // L: Durum
            data.notes      // M: Not_Ozet
          ]]);

          // P (16) ve Q (17) Sütunları -> Güncelleme Tarihi ve Guncelleyen
          sheet.getRange(i + 1, 16, 1, 2).setValues([[now, currentUser]]);

          return { status: "success", message: "Müşteri bilgileri güncellendi." };
        }
      }
      return { status: "error", message: "Güncellenecek kayıt bulunamadı." };
    } 
    
    // B. YENİ EKLEME (ID yoksa)
    else {
      const newId = "CUST-" + now.getTime();
      const newRow = [
        newId,           // A: Musteri_ID (1)
        data.name,       // B: Firma_Adi (2)
        data.type,       // C: Tip (3)
        data.country,    // D: Ulke (4)
        data.city,       // E: Sehir (5)
        data.phone,      // F: Telefon (6)
        data.email,      // G: E_Posta (7)
        data.website,    // H: Web_Sitesi (8)
        data.address,    // I: Adres (9)
        data.payment,    // J: Odeme_Sekli (10)
        data.shipping,   // K: Nakliye_Tipi (11)
        data.status,     // L: Durum (12)
        data.notes,      // M: Not_Ozet (13)
        now,             // N: Olusturma_Tarihi (14)
        currentUser,     // O: Olusturan_Kullanici_ID (15)
        now,             // P: Guncelleme_Tarihi (16)
        currentUser      // Q: Guncelleyen_Kullanici_ID (17)
      ];

      sheet.appendRow(newRow);
      return { status: "success", message: "Yeni müşteri başarıyla eklendi." };
    }
  } catch (err) {
    return { status: "error", message: "Kaydetme hatası: " + err.toString() };
  }
}

// 4. Müşteri Silme (GÜVENLİK KONTROLLÜ)
function deleteCustomer(id) {
  try {
    const ss = SpreadsheetApp.openById(DB_ID);
    
    // İlişkili tablo kontrolleri (Korumalı Silme)
    if (hasRelatedRecord(ss, "Ilgili_Kisiler", 1, id)) 
      return { status: "error", message: "Silinemez! Bu müşteriye bağlı 'Kişiler' var." };
      
    if (hasRelatedRecord(ss, "Gorevler", 1, id)) 
      return { status: "error", message: "Silinemez! Bu müşteriye bağlı 'Görevler' var." };

    const sheet = ss.getSheetByName("Musteriler");
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == id) {
        sheet.deleteRow(i + 1);
        return { status: "success", message: "Müşteri başarıyla silindi." };
      }
    }
    return { status: "error", message: "Kayıt bulunamadı." };
  } catch (err) {
    return { status: "error", message: "Silme hatası: " + err.toString() };
  }
}

// YARDIMCI: İlişkili tablo kontrolü
function hasRelatedRecord(ss, sheetName, colIndex, searchId) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return false; 
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][colIndex] == searchId) return true;
  }
  return false; 
}
